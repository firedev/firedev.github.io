<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Boring Rails</title>
  <meta name="description" content="Nintendo is known for using boring technologies. Not the worst plan. Here are some tips on handling complexity on Rails in a boring pragmatic way.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://firedev.com/posts/boring-rails/">
  <link rel="alternate" type="application/rss+xml" title="firedev.com" href="https://firedev.com/feed.xml" />

  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <link href="/images/favicon.png" rel="icon" />
  <link href="/images/favicon.png" rel="apple-touch-icon-precomposed" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">

  <meta property="og:url" content="https://firedev.com/posts/boring-rails/" />
  <meta property="og:title" content="Boring Rails" />
  <meta property="og:description" content="Nintendo is known for using boring technologies. Not the worst plan. Here are some tips on handling complexity on Rails in a boring pragmatic way.
" />
  <meta property="og:image" content="https://firedev.com/images/posts/kote-puerto-f4Jyy2OIZ54-unsplash.jpg" />
</head>


<body class="m-auto prose prose-neutral lg:text-xl">
  <div class="max-w-6xl px-4 mx-auto">
    <header class="sm:grid grid-cols-4 gap-8 mb-4">
  <a href="/" class="block leading-4 aspect-w-3 aspect-h-1 overflow-hidden"
    style="background: bottom left no-repeat url(/images/logos/firedev.svg);">
    <h1 class="text-8xl leading-4 block invisible">
      firedev.com
    </h1>
  </a>

  <div class="mb-8 sm:hidden"></div>

  <nav class="col-span-3 flex flex-wrap gap-8 items-end  leading-6 text-5xl sm:text-2xl">

    
    
    
    
    
    <a class=" font-normal text-gray-600" href="/posts/">
      Posts
    </a>
    
    
    
    
    
    <a class=" font-normal text-gray-600" href="/projects/">
      Projects
    </a>
    
    
    
    
    
    
    
    <a class=" font-normal text-gray-600" href="/about/">
      About
    </a>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <div class="flex flex-auto"></div>

    <a class="hidden sm:block font-normal opacity-50 text-sm text-gray-600" href=" /feed.xml">
      <i class="fa fa-rss"></i>
      RSS

    </a>
  </nav>
</header>

  </div>
  
  <div class="my-8" style="
    padding-top: 42%;
    background-image: url(/images/posts/kote-puerto-f4Jyy2OIZ54-unsplash.jpg);
    background-size: cover;
    background-color: ;
    background-position: ;
  "></div>


  <div class="max-w-6xl px-4 mx-auto">
    

<header>
  
  <h1 class="m0 mb-4">Boring Rails</h1>
</header>


<div class="mb-6">
  <article class="mb-6">
    <p>Nintendo is known for using boring technologies. Not the worst plan. Here are some tips on handling complexity on Rails in a boring pragmatic way.</p>

<ul>
  <li>https://www.youtube.com/watch?v=NbMt4uFIL8c</li>
  <li>https://www.youtube.com/watch?v=Mq6MuwLMEUU</li>
</ul>

<hr />

<!-- TOC -->

<ul>
  <li><a href="#models-hierarchy">Models Hierarchy</a></li>
  <li><a href="#state-machines">State machines</a></li>
  <li><a href="#repositories">Repositories</a></li>
  <li><a href="#presenters">Presenters</a></li>
  <li><a href="#forms-validation-and-data-normalization">Forms Validation and Data Normalization</a></li>
  <li><a href="#controllers-hierarchy">Controllers Hierarchy</a></li>
  <li><a href="#authorization">Authorization</a></li>
  <li><a href="#mutators">Mutators</a></li>
  <li><a href="#service-layer">Service Layer</a></li>
  <li><a href="#dependency-inversion">Dependency Inversion</a></li>
  <li><a href="#null-object">Null Object</a></li>
  <li><a href="#business-logic">Business Logic</a>
    <ul>
      <li><a href="#controller-%E2%86%92-business">Controller → Business</a>
        <ul>
          <li><a href="#return-result">Return result</a></li>
          <li><a href="#data-validation">Data Validation</a></li>
        </ul>
      </li>
      <li><a href="#business-%E2%86%92-controller">Business → Controller</a></li>
      <li><a href="#business-%E2%86%92-business">Business → Business</a>
        <ul>
          <li><a href="#testing">Testing</a></li>
          <li><a href="#chaining">Chaining</a></li>
        </ul>
      </li>
      <li><a href="#db-%E2%86%92-business">DB → Business</a>
        <ul>
          <li><a href="#transactions">Transactions</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<!-- /TOC -->

<h2 id="models-hierarchy">Models Hierarchy</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>models/
  blog_post/
    category.rb
    vote.rb
  code_review/
    submission/
      comment.rb
    submission.rb
  company/
    group/
      member.rb
  course/
    build.rb
    challenge.rb
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/course/challenge.rb</span>

<span class="k">class</span> <span class="nc">Course::Challenge</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:exercise</span>
  <span class="n">belongs_to</span> <span class="ss">:exercise</span><span class="p">,</span> <span class="ss">inverse_of: :course_challenge</span>
  <span class="n">belongs_to</span> <span class="ss">:course</span>
  <span class="o">...</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="state-machines">State machines</h2>

<ul>
  <li><a href="https://github.com/aasm/aasm"><code class="language-plaintext highlighter-rouge">aasm</code></a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">state_machine</span> <span class="ss">:stripe_state</span><span class="p">,</span> <span class="ss">initial: </span><span class="n">synchronized</span><span class="p">,</span> <span class="ss">namespace: </span><span class="n">stripe</span> <span class="k">do</span>
  <span class="n">state</span> <span class="ss">:synchronized</span>
  <span class="n">state</span> <span class="ss">:synchronizing</span>
  <span class="n">state</span> <span class="ss">:invalidated</span>

  <span class="n">event</span> <span class="ss">:invalidate</span> <span class="k">do</span>
    <span class="n">transition</span> <span class="ss">all: :invalidated</span>
  <span class="k">end</span>

  <span class="n">event</span> <span class="ss">:synchronize</span> <span class="k">do</span>
    <span class="n">transition</span> <span class="ss">invalidated: :synchronized</span>
  <span class="k">end</span>

  <span class="n">event</span> <span class="ss">:mark_as_synchronized</span> <span class="k">do</span>
    <span class="n">transition</span> <span class="ss">synchonizing: :synchronized</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="repositories">Repositories</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/repositories/lesson_repository.rb</span>

<span class="k">module</span> <span class="nn">LessonRepository</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
  <span class="kp">include</span> <span class="no">StateMachine</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">scope</span> <span class="ss">:web</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">approved</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:course</span><span class="p">).</span><span class="nf">merge</span><span class="p">(</span><span class="no">Course</span><span class="p">.</span><span class="nf">web</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">scope</span> <span class="ss">:with_locale</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">locale</span><span class="p">)</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="ss">:course</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">courses: </span><span class="p">{</span> <span class="ss">locale: </span><span class="n">locale</span> <span class="p">})</span> <span class="p">}</span>
    <span class="n">scope</span> <span class="ss">:with_members</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="s2">"..."</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">...</span>
</code></pre></div></div>

<h2 id="presenters">Presenters</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/presenters/user_presenter.rb</span>

<span class="k">module</span> <span class="nn">UserPresenter</span>
  <span class="k">def</span> <span class="nf">public_name</span>
    <span class="k">return</span> <span class="n">full_name</span> <span class="k">if</span> <span class="n">full_name</span><span class="p">.</span><span class="nf">present?</span>
    <span class="k">return</span> <span class="n">username</span> <span class="k">if</span> <span class="n">username?</span>
  <span class="k">end</span>
</code></pre></div></div>

<h2 id="forms-validation-and-data-normalization">Forms Validation and Data Normalization</h2>

<ul>
  <li><a href="https://github.com/Hexlet/active_form_model"><code class="language-plaintext highlighter-rouge">active_form_model</code></a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/forms/user/sign_up_form.rb</span>

<span class="k">class</span> <span class="nc">User::SignUpForm</span> <span class="o">&lt;</span> <span class="no">User</span>
  <span class="kp">include</span> <span class="no">ActiveFormModel</span>

  <span class="n">permit</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:first_name</span>

  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">length: </span><span class="p">{</span> <span class="ss">minimum: </span><span class="mi">8</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">email</span><span class="o">=</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">email</span><span class="p">.</span><span class="nf">present?</span>
      <span class="n">write_attribute</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="n">email</span><span class="p">.</span><span class="nf">downcase</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="controllers-hierarchy">Controllers Hierarchy</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>controllers/
  web/
    projects/
      members/
        comments_controller.rb
    application_controller.rb
  application_controller.rb
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/web/projects/members/comments_controller.rb</span>

<span class="k">class</span> <span class="nc">Web::Projects::Members::CommentsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">ApplicationController</span>
  <span class="o">...</span>
</code></pre></div></div>

<h2 id="authorization">Authorization</h2>

<p>Layer above models</p>

<ul>
  <li><a href="https://github.com/varvet/pundit"><code class="language-plaintext highlighter-rouge">pundit</code></a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/policies/resume/answer/comment_policy.rb</span>

<span class="k">class</span> <span class="nc">Resume::Answer::CommentPolicy</span> <span class="o">&lt;</span> <span class="no">ApplicationPolicy</span>
  <span class="k">def</span> <span class="nf">edit?</span>
    <span class="n">author?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy?</span>
    <span class="n">author?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update?</span>
    <span class="n">author?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="mutators">Mutators</h2>

<ul>
  <li>Callbacks replacement.</li>
  <li>Anything more complex than <code class="language-plaintext highlighter-rouge">create(params)</code> goes to mutators.</li>
  <li>Nothing except working with entity</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/mutators/resume/answer_mutator.rb</span>

<span class="k">module</span> <span class="nn">Resume::AnswerMutator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create</span><span class="p">(</span><span class="n">resume</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">resume</span><span class="p">.</span><span class="nf">answers</span><span class="p">.</span><span class="nf">build</span> <span class="n">params</span>
    <span class="n">answer</span><span class="p">.</span><span class="nf">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="n">resume</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">notifications</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">kind: :new_answer</span><span class="p">,</span> <span class="ss">resource: </span><span class="n">answer</span><span class="p">)</span> <span class="k">if</span> <span class="n">answer</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">answer</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="service-layer">Service Layer</h2>

<ul>
  <li>Synchronous. Stateless.</li>
  <li><a href="/posts/functional-service-objects-on-rails/">Functional service objects on rails</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/services/user_service.rb</span>

<span class="k">class</span> <span class="nc">UserService</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">update_current_tutor</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="no">UserMutator</span><span class="p">.</span><span class="nf">assign_tutor!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="no">AnalyticsSender</span><span class="p">.</span><span class="nf">track</span><span class="p">(</span><span class="ss">:tutor_assigned</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Web::Projects::Members::CommentsController</span> <span class="o">&lt;</span> <span class="no">Web</span><span class="o">::</span><span class="no">Projects</span><span class="o">::</span><span class="no">Members</span><span class="o">::</span><span class="no">ApplicationController</span>
  <span class="n">before_action</span> <span class="ss">:require_email_confirmation!</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">member</span> <span class="o">=</span> <span class="no">Project</span><span class="o">::</span><span class="no">Mmember</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:member_id</span><span class="p">])</span>
    <span class="n">authorize</span> <span class="n">member</span><span class="p">,</span> <span class="ss">:create_comment?</span>

    <span class="n">comment</span> <span class="o">=</span> <span class="no">ProjectService</span><span class="p">.</span><span class="nf">create_comment</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">permitted_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comment</span><span class="p">.</span><span class="nf">persisted?</span>
      <span class="n">f</span><span class="p">(</span><span class="ss">:success</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">f</span><span class="p">(</span><span class="ss">:error</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">redirect_to</span> <span class="n">project_member_path</span><span class="p">(</span><span class="n">member</span><span class="p">.</span><span class="nf">project</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">permitted_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:project_member_comment</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:body</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<h2 id="dependency-inversion">Dependency Inversion</h2>

<ul>
  <li>No monkey-patching</li>
  <li><a href="https://dry-rb.org/gems/dry-container/">dry-rb/dry-container</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
  <span class="n">register</span> <span class="ss">:active_campaign</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">ActivecampaignManager</span><span class="p">.</span><span class="nf">new</span> <span class="n">configus</span><span class="p">.</span><span class="nf">ac</span><span class="p">.</span><span class="nf">api</span><span class="p">.</span><span class="nf">token</span> <span class="p">}</span>
<span class="k">else</span>
  <span class="n">register</span> <span class="ss">:active_compaign</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">ActivecampaignManagerStub</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">if</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">test?</span>
  <span class="n">register</span> <span class="ss">:gitlab_klass</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">GitlabStub</span> <span class="p">}</span>
<span class="k">else</span>
  <span class="n">register</span> <span class="ss">:gitlab_klass</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="no">Gitlab</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AmplitudeJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="kp">include</span> <span class="no">Import</span><span class="p">[</span><span class="s1">'amplitude_klass'</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event_data</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="nb">name</span> <span class="o">=</span> <span class="no">EventsMapping</span><span class="p">.</span><span class="nf">amplitude_names</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">event</span> <span class="o">=</span> <span class="no">AmplitudeAPI</span><span class="o">::</span><span class="no">Event</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">amplitude_klass</span><span class="p">.</span><span class="nf">track</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="null-object">Null Object</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="o">&amp;&amp;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">friends</span><span class="p">.</span><span class="nf">any?</span>
</code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Guest</span>
  <span class="k">def</span> <span class="nf">id</span><span class="p">;</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nf">created_at</span>
    <span class="no">Time</span><span class="p">.</span><span class="nf">current</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">employee</span>
    <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">_password</span><span class="p">)</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">current_user</span>
  <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">id: </span><span class="n">session</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">])</span> <span class="o">||</span> <span class="no">Guest</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="business-logic">Business Logic</h2>

<ul>
  <li>Business-logic kept isolated from implementation details - Services, Interfaces, DB</li>
  <li>Inject everything</li>
</ul>

<ol>
  <li>Controller → Business</li>
  <li>Business → Controller</li>
  <li>Business ←→ Business</li>
  <li>DB ←→ Business</li>
</ol>

<h3 id="1-controller--business">1. Controller → Business</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Operation</code> is a good pattern-free word</li>
  <li>Unified Interface</li>
  <li>Railway oriented programming</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app/
  controllers/
    clients_controller.rb
  operations/
    clients/
      confirmations/
        start.rb
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">operation</span> <span class="o">=</span> <span class="no">Clients</span><span class="o">::</span><span class="no">Confirmations</span><span class="o">::</span><span class="no">Start</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">handle_result</span> <span class="n">operation</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">transaction: </span><span class="n">transaction</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="return-result">Return result</h4>

<ul>
  <li>Result object</li>
  <li><a href="https://dry-rb.org/gems/dry-monads/"><code class="language-plaintext highlighter-rouge">dry-rb/dry-monads</code></a></li>
  <li><a href="https://dry-rb.org/gems/dry-monads/1.3/do-notation/">Do Notation</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Clients::Confirmations::Start</span> <span class="o">&lt;</span> <span class="no">Operation</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">transaction</span><span class="p">:)</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">transaction_eligible?</span> <span class="n">transaction</span>
    <span class="k">return</span> <span class="sc">??</span><span class="p">?</span> <span class="k">unless</span> <span class="n">valid</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">generate_code</span> <span class="n">transaction</span>
    <span class="k">return</span> <span class="sc">??</span><span class="p">?</span> <span class="k">unless</span> <span class="n">code</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">send_code</span> <span class="n">code</span>
    <span class="k">return</span> <span class="sc">??</span><span class="p">?</span> <span class="k">unless</span> <span class="n">code</span>

    <span class="n">transaction</span> <span class="p">?</span><span class="sc">??</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Clients::Confirmations::Start</span> <span class="o">&lt;</span> <span class="no">Operation</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">transaction</span><span class="p">:)</span>
    <span class="c1"># Success() or Failure(...)</span>
    <span class="k">yield</span> <span class="n">transaction_eligible?</span> <span class="n">transaction</span>
    <span class="c1"># Success(code) or Failure(...)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">generate_code</span> <span class="n">transaction</span>
    <span class="c1"># Success() or Failure(...)</span>
    <span class="k">yield</span> <span class="n">send_code</span> <span class="n">code</span>

    <span class="no">Success</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="data-validation">Data Validation</h4>

<ul>
  <li>Validate user data not domain objects</li>
  <li>Always valid objects</li>
  <li><code class="language-plaintext highlighter-rouge">dry-rb/dry-validation</code>[https://dry-rb.org/gems/dry-validation/]</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Profile</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:birthdate</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProfileContract</span> <span class="o">&lt;</span> <span class="no">Contract</span>
  <span class="n">params</span> <span class="k">do</span>
    <span class="n">required</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">filled</span><span class="p">(</span><span class="ss">:string</span><span class="p">)</span>
    <span class="n">required</span><span class="p">(</span><span class="ss">:birthdate</span><span class="p">).</span><span class="nf">value</span><span class="p">(</span><span class="ss">:date</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="2-business--controller">2. Business → Controller</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">operation</span> <span class="o">=</span> <span class="no">Clients</span><span class="o">::</span><span class="no">Confirmations</span><span class="o">::</span><span class="no">Start</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">handle_result</span> <span class="n">operation</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">transaction: </span><span class="n">transaction</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">handle_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">result</span>
  <span class="k">when</span> <span class="no">Success</span><span class="p">()</span> <span class="k">then</span> <span class="n">head</span><span class="p">(</span><span class="ss">:ok</span><span class="p">)</span>
  <span class="k">when</span> <span class="no">Success</span> <span class="k">then</span> <span class="n">respond_with_data</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">value!</span><span class="p">)</span>
  <span class="k">when</span> <span class="no">Failure</span> <span class="k">then</span> <span class="n">respond_with_error</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="nf">failure</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="3-business--business">3. Business → Business</h3>

<ul>
  <li>Dependency injection</li>
  <li><a href="https://dry-rb.org/gems/dry-initializer">https://dry-rb/dry-initializer</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Confirmations</span>
  <span class="k">class</span> <span class="nc">Start</span> <span class="o">&lt;</span> <span class="no">Operation</span>
    <span class="n">option</span> <span class="ss">:generate_code_command</span><span class="p">,</span>
      <span class="ss">reader: :private</span><span class="p">,</span>
      <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="no">ConfirmationCodes</span><span class="o">::</span><span class="no">Generate</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">transaction</span><span class="p">:)</span>
      <span class="n">code</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">generate_code_command</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">source: </span><span class="n">transaction</span><span class="p">)</span>
      <span class="o">...</span>
</code></pre></div></div>

<h4 id="testing">Testing</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="no">Clients</span><span class="o">::</span><span class="no">Confirmations</span><span class="o">::</span><span class="no">Start</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">"#call"</span> <span class="k">do</span>
    <span class="n">described_class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">generate_code_command: </span><span class="n">generate_code_command</span><span class="p">).</span><span class="nf">call</span>
  <span class="k">end</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:generate_code_command</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="no">ConfirmationCodes</span><span class="o">::</span><span class="no">Generate</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">generate_code_command</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:call</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="o">...</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="o">...</span>
</code></pre></div></div>

<h4 id="chaining">Chaining</h4>

<ul>
  <li>Railway oriented programming https://vimeo.com/113707214</li>
  <li>Command-Query Segregation</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   steps
   1   2   3
---*---*---*------ happy path
    \   \   \
------------------ error
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Clients::Confirmations::Start</span> <span class="o">&lt;</span> <span class="no">Operation</span>
  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">transaction</span><span class="p">:)</span>
    <span class="c1"># Success() or Failure(...)</span>
    <span class="k">yield</span> <span class="n">transaction_eligible?</span> <span class="n">transaction</span>
    <span class="n">code</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">generate_code</span> <span class="n">transaction</span>
    <span class="k">yield</span> <span class="n">send_code</span> <span class="n">code</span>
     <span class="no">Success</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="4-db--business">4. DB → Business</h3>

<ul>
  <li>Inject repository</li>
  <li>Single Responsibility Principles</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Confirmations</span>
  <span class="k">class</span> <span class="nc">Generate</span> <span class="o">&lt;</span> <span class="no">Operation</span>
    <span class="n">option</span> <span class="ss">:codes_repo</span><span class="p">,</span>
      <span class="ss">reader: :private</span><span class="p">,</span>
      <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="no">ConfirmationCode</span> <span class="p">}</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">persist_code</span><span class="p">(</span><span class="n">code_attributes</span><span class="p">)</span>
    <span class="n">codes_repo</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">code_attributes</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="transactions">Transactions</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Confirmation</span>
  <span class="k">class</span> <span class="nc">Verify</span> <span class="o">&lt;</span> <span class="no">Operation</span>
    <span class="n">option</span> <span class="ss">:repo</span><span class="p">,</span>
      <span class="ss">reader: :private</span><span class="p">,</span>
      <span class="ss">default: </span><span class="o">-&gt;</span> <span class="p">{</span> <span class="no">ApplicationRecord</span> <span class="p">}</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">transaction</span><span class="p">:,</span> <span class="n">confirmation_code</span><span class="p">:)</span>
      <span class="n">repo</span><span class="p">.</span><span class="nf">transaction</span> <span class="k">do</span>
        <span class="k">yield</span> <span class="n">confirm_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">confirm_transaction</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div></div>

  </article>

  <div class="my-8 leading-8 lg:leading-9 -ml-1">
 

<a href="/ruby/" class="rounded bg-orange white font-normal py-1 px-1.5 ml-1"> Ruby </a>
 

<a href="/rails/" class="rounded bg-orange white font-normal py-1 px-1.5 ml-1"> Rails </a>
 

<a href="/refactoring/" class="rounded bg-orange white font-normal py-1 px-1.5 ml-1"> Refactoring </a>

</div>


</div>
<div class="mt-8">
<div class="sm:grid grid-cols-4 gap-8 my-16">
  <div class="mb-4">
    <img class="rounded" src="/images/me.jpg" alt="Hello!" />
  </div>
  <div class="col-span-3">

    <h2 class="h1">
      Nikolay Ostrovsky
    </h2>

    <div class="sm:grid grid-cols-3 gap-8 mb-8">
      <div class="col-span-2">
        <p class="mt-0">
          Startup Team Lead. I like everything minimal and as simple as possible.
        </p>
        <p>
          Grew from Web and Graphics through User Experience and
          Interfaces, Backend and Frontend programming to Team Lead and CTO.
          Contributed to projects for major brands. L'Oreal,
          JTI and AB InBev among others.
        </p>
      </div>


      <div class="col-span-1 leading-6">

        <!-- <a class="py-1 px-4 white bg-green rounded mb-2 inline-block" href="mailto:nick@firedev.com" -->
        <!-- title="Hey, I am looking for a team to join"><i class="fa fa-cog"></i> <b>Looking</b></a> -->
        <a class="py-1 px-4 block" href="http://github.com/firedev"><i class="fa fa-github w-5 mr-1 text-right"></i> Github</a>
        <a class="py-1 px-4 block" href="http://twitter.com/firedev"><i class="fa fa-twitter w-5 mr-1 text-right"></i> Twitter</a>
        <!--<a class="py-1 px-4 block" href="http://twitter.com/_dearapple"><i class="fa fa-twitter"></i>@_dearapple</a>-->
        <a class="py-1 px-4 block" href="http://stackoverflow.com/users/166484/nick"><i class="fa fa-stack-overflow w-5 mr-1 text-right"></i>
          StackOverflow</a>
        <a class="py-1 px-4 block" href="mailto:nick@firedev.com"><i class="fa fa-envelope w-5 mr-1 text-right"></i> Email Me</a>
        <a class="py-1 px-4 block" href="/cv"><i class="fa fa-file w-5 mr-1 text-right"></i>
          CV</a>
      </div>
    </div>
  </div>
</div>

</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES * * */
var disqus_shortname = 'firedevcom';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


    <footer class="text-center">
    <div class="py-8 my-8 text-gray-700">
        With <i class="fa fa-heart text-red-700"></i>
        <a href="http://firedev.com" class="text-gray-700"><strong>firedev.com</strong></a>
    </div>

</footer>

    <script src="/js/firedev.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69016906-1', 'auto');
  ga('send', 'pageview');

</script>

  </div>
</body>

</html>
